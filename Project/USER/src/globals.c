#include "globals_ex.h"

/*
 * ============================================================================
 *                              全局变量定义
 * ============================================================================
 * @note   此文件用于定义项目中使用的所有全局变量。
 *         对应的 "globals_ex.h" 文件应包含这些变量的 `extern` 声明。
 * @author yanyyy
 * @date   2025-0-19
 * ============================================================================
 */


//-----------------------------------------------------------------------------
// 1. 小车速度与行驶控制 (Speed & Drive Control)
//-----------------------------------------------------------------------------
uint8 setSpeed = 0;               // 电机目标速度设定值
uint8 lowSpeed = 41;              // 预设低速值
uint8 normalSpeed = 45;           // 预设常规速度值
uint8 botSpeed = 52;              // 预设高速值 (可能用于特定路段)

int32 distance_set = 0;           // 目标行驶距离 (编码器计数)
int32 distance_accu = 0;          // 已累计行驶距离 (编码器计数)

int16 angle_set = 0;              // 目标转动角度 (陀螺仪积分值)
int16 angle_accu = 0;             // 已累计转动角度 (陀螺仪积分值)


//-----------------------------------------------------------------------------
// 2. 电池与充电管理 (Battery & Charging)
//-----------------------------------------------------------------------------
uint16 ad_result = 0;             // ADC单次采样原始值 (常用于电压检测)
uint16 battery_voltage = 0;       // 计算后的电池电压值 (单位: mV)
uint16 battery_voltage_temp = 0;  // 电压计算的中间临时变量
uint8  charge_flag = 1;           // 充电状态标志位 (1: 正在充电, 0: 充电完成)


//-----------------------------------------------------------------------------
// 3. 电机与编码器 (Motor & Encoder)
//-----------------------------------------------------------------------------
int   encoderL = 0;               // 左轮编码器读数
int   encoderR = 0;               // 右轮编码器读数
int16 Lputout = 0;                // 左电机PWM输出值
int16 Rputout = 0;                // 右电机PWM输出值

// --- 电机PID控制误差变量 (增量式PID或调试用) ---
float errorL = 0;                 // 左电机本次误差
float errorR = 0;                 // 右电机本次误差
float errorL_Before = 0;          // 左电机上一次误差
float errorR_Before = 0;          // 右电机上一次误差
float errorL_Before_Before = 0;   // 左电机上上次误差
float errorR_Before_Before = 0;   // 右电机上上次误差


//-----------------------------------------------------------------------------
// 4. PID 控制参数 (PID Control Parameters)
//-----------------------------------------------------------------------------
// --- 电机闭环PID ---
int16 motor_kp = 30;              // 电机速度环 P系数
int16 motor_ki = 2;               // 电机速度环 I系数
int16 motor_kd = 7;               // 电机速度环 D系数

// --- 循迹差动(电感)PID ---
float adc_kp1 = 30.9;             // 循迹控制 P系数 (主)
float adc_kp2 = 20;               // 循迹控制 P系数 (次，可能用于大偏差)
float adc_ki = 0;                 // 循迹控制 I系数
float adc_kd = 830;               // 循迹控制 D系数

// --- 姿态控制(陀螺仪)PID ---
float gyro_kp = 0.0051;           // 姿态控制(Z轴角速度) P系数
float gyro_kd = 0.001;            // 姿态控制(Z轴角速度) D系数


float fix;                        // PID计算后的最终修正值


//-----------------------------------------------------------------------------
// 5. 电磁传感器数据处理 (ADC Sensor Data)
//-----------------------------------------------------------------------------
// --- 传感器滑动平均滤波 ---
uint16 adc_buffer_user[6][4] = {0}; // 各通道滑动窗口缓冲区
uint8  adc_index_user[6] = {0};     // 各通道当前索引
uint32 adc_total_user[6] = {0};     // 各通道累加和

// --- 传感器处理后数据 ---
uint16 adc_pre[6] = {0};          // 滤波后的各通道电感值
uint16 adc_guiyi[6] = {0};        // 归一化后的各通道电感值 (0-100)
uint16 adc_sum;                   // 电感值总和

// --- 传感器归一化标定值 (当前生效) ---
// 索引对应: [0:无效, 1:左横, 2:左竖, 3:右竖, 4:右横, 5:中]
uint16 adc_max[6] = {9999, 1920, 2180, 2850, 3280, 1950}; // 各通道最大值
uint16 adc_min[6] = {8888,  150,   50,    0,  110,   80}; // 各通道最小值


//-----------------------------------------------------------------------------
// 6. 循迹控制中间变量 (Steering Control Variables)
//-----------------------------------------------------------------------------
float adc_target = 0.0;           // 循迹目标值 (通常为0，表示在中心)
float adcError = 0.0;             // 本次循迹偏差
float prevAdcError = 0.0;         // 上一次循迹偏差
float adcIntegral = 0.0;          // 循迹偏差积分项
float adcDerivative = 0.0;        // 循迹偏差微分项
float adc_actual = 0.0;           // 加权计算后的当前赛道位置
float adcError_abs = 0.0;         // 循迹偏差绝对值
int   adcError_int = 0;           // 循迹偏差整数形式 (便于显示或传输)
int   adc_actual_int = 0;         // 当前位置整数形式 (便于显示或传输)


//-----------------------------------------------------------------------------
// 7. IMU 姿态数据 (IMU Attitude Data)
//-----------------------------------------------------------------------------
// --- IMU 原始数据 ---
int16 gyro_x_raw = 0;             // 陀螺仪X轴原始读数
int16 gyro_y_raw = 0;             // 陀螺仪Y轴原始读数
int16 gyro_z_raw = 0;             // 陀螺仪Z轴原始读数
int16 acc_x_raw = 0;              // 加速度计X轴原始读数
int16 acc_y_raw = 0;              // 加速度计Y轴原始读数
int16 acc_z_raw = 0;              // 加速度计Z轴原始读数

// --- 处理后数据 ---
int gyroX = 0;                    // (处理后) X轴角速度
int gyroY = 0;                    // (处理后) Y轴角速度
int gyroZ = 0;                    // (处理后) Z轴角速度
int accelX = 0;                   // (处理后) X轴加速度
int accelY = 0;                   // (处理后) Y轴加速度
int accelZ = 0;                   // (处理后) Z轴加速度

// --- 姿态角 (通过积分计算) ---
float angleX_gyro;                // 绕X轴积分得到的角度 (横滚角 Roll)
float angleY_gyro;                // 绕Y轴积分得到的角度 (俯仰角 Pitch)
float angleZ_gyro;                // 绕Z轴积分得到的角度 (偏航角 Yaw)

// --- IMU 零点漂移补偿值 ---
uint8 imu963ra_offset_flag = 0;   // IMU零点校准完成标志
int   offset_gx = 0;              // 陀螺仪X轴零漂值
int   offset_gy = 0;              // 陀螺仪Y轴零漂值
int   offset_gz = 0;              // 陀螺仪Z轴零漂值
int   offset_accx = 0;            // 加速计X轴零漂值
int   offset_accy = 0;            // 加速计Y轴零漂值
int   offset_accz = 0;            // 加速计Z轴零漂值
int32 offset_acc_temp = 0;        // 加速度计校准时用的临时累加值

// --- 陀螺仪控制中间变量 ---
int gyroZ_before = 0;             // 上一次Z轴角速度值
int gyroZ_Derivative = 0;         // Z轴角速度微分 (角加速度)
int gyroZ_min = 0;                // (特定功能) 用于圆环积分的Z轴角速度值


//-----------------------------------------------------------------------------
// 8. 赛道元素处理 (Road Element Handling)
//-----------------------------------------------------------------------------
// --- 状态与标志位 ---
RoadItems currItem;               // 当前识别到的赛道元素
RoadItems lastItem;               // 上一个赛道元素
uint8 get_in_island_FLAG = 0;     // 进入环岛标志
uint8 before_get_in_island = 0;   // 即将入环标志
uint8 circle_direc_FLAG = 0;      // 环岛方向标志
uint8 jumpIsland = 0;             // (特定功能) 跳出环岛标志
uint8 block_FLAG = 0;             // 障碍处理标志
uint8 ramp_FLAG = 0;              // 坡道处理标志
uint8 order_FLAG = 1;             // 元素处理顺序标志 (1:先障后坡, 2:先坡后障)

// --- 可调参数 ---
uint16 outIslandTurn = 60000;     // 出环岛转向参数
uint16 outIslandStraight = 0;     // 出环岛直行参数
uint16 blockLeft = 5200;          // 避障左转参数
uint16 blockRight = 11000;        // 避障右转参数
uint16 blockBack = 3800;          // 避障后退参数
uint16 rampset = 7000;            // 坡道处理参数


//-----------------------------------------------------------------------------
// 9. UI界面与通信 (UI & Communication)
//-----------------------------------------------------------------------------
char  text[24];                   // 屏幕显示用字符串缓冲区
uint8 screenItem = 0;             // 主屏幕显示项目索引
uint8 oscilloscopeItem = 0;       // 虚拟示波器显示项目索引
uint8 paramChoice = 0;            // 参数调节项目索引
UARTN_enum UART_Using = UART_4;   // 当前使用的串口号


/*
 * ============================================================================
 *                         历史电感标定数据
 * ============================================================================
 */
// 此处存放历史上用于电感归一化的最大/最小值，可用于调试或快速恢复
/*
//五电感（短杆）缩短前瞻 昨晚跑刚
//uint16 adc_max[6] = {9999, 2000, 2170, 2700, 3100, 2020};
//uint16 adc_min[6] = {8888, 200, 50, 60, 200, 50};

//2025 0719 1913            横    竖    竖    横     中
//uint16 adc_max[6] = {9999, 1900, 2180, 2850, 3030, 1950};
//uint16 adc_min[6] = {8888,  150,   50,    0,  110,   80};

//用于获取最大值
//uint16 adc_max[6]={0,0,0,0,0,0};
//uint16 adc_min[6]={999,999,999,999,999,999};
*/
